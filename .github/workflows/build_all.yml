name: GodotJS Dependencies (All)

on:
  workflow_dispatch:
    inputs:
      bundle_tag:
        description: 'package version tag'
        type: string
        required: true
      v8_version:
        description: 'v8 version tag'
        type: choice
        options:
          - "13.5.119"
          - "12.9.202.28" # 2022
          - "12.4.254.21" # 2019
        required: true
        default: "13.5.119"

jobs:
  v8_android_arm64:
    uses: ./.github/workflows/build_v8_android_arm64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_android_arm32:
    uses: ./.github/workflows/build_v8_android_arm32.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_android_x86_64:
    uses: ./.github/workflows/build_v8_android_x86_64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_ios_arm64:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_v8_ios_arm64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_macos_arm64:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_v8_macos_arm64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_macos_x86_64:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_v8_macos_x86_64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_linux_x86_64:
    uses: ./.github/workflows/build_v8_linux_x86_64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_linux_arm64:
    uses: ./.github/workflows/build_v8_linux_arm64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_windows_x86_64:
    if: ${{ vars.SKIP_WINDOWS != 'true' }}
    uses: ./.github/workflows/build_v8_windows_x86_64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_windows_arm64:
    if: ${{ vars.SKIP_WINDOWS != 'true' }}
    uses: ./.github/workflows/build_v8_windows_arm64.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  lws_linux_x86_64:
    uses: ./.github/workflows/build_lws_linux_x86_64.yml
    secrets: inherit

  lws_linux_arm64:
    uses: ./.github/workflows/build_lws_linux_arm64.yml
    secrets: inherit

  # Android LWS builds (use NDK r23c toolchain)
  lws_android_arm64:
    uses: ./.github/workflows/build_lws_android_arm64.yml
    secrets: inherit

  lws_android_arm32:
    uses: ./.github/workflows/build_lws_android_arm32.yml
    secrets: inherit

  lws_android_x86_64:
    uses: ./.github/workflows/build_lws_android_x86_64.yml
    secrets: inherit

  lws_ios_arm64:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_lws_ios_arm64.yml
    secrets: inherit

  lws_macos_arm64:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_lws_macos_arm64.yml
    secrets: inherit

  lws_macos_x86_64:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_lws_macos_x86_64.yml
    secrets: inherit

  lws_windows_x86_64:
    if: ${{ vars.SKIP_WINDOWS != 'true' }}
    uses: ./.github/workflows/build_lws_windows_x86_64.yml
    secrets: inherit

  lws_windows_arm64:
    if: ${{ vars.SKIP_WINDOWS != 'true' }}
    uses: ./.github/workflows/build_lws_windows_arm64.yml
    secrets: inherit

  publish:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    needs:
      - v8_android_arm32
      - v8_android_arm64
      - v8_android_x86_64
      - v8_ios_arm64
      - v8_macos_arm64
      - v8_macos_x86_64
      - v8_linux_arm64
      - v8_linux_x86_64
      - v8_windows_arm64
      - v8_windows_x86_64
      - lws_linux_x86_64
      - lws_linux_arm64
      - lws_android_arm64
      - lws_android_arm32
      - lws_android_x86_64
      - lws_ios_arm64
      - lws_macos_arm64
      - lws_macos_x86_64
      - lws_windows_arm64
      - lws_windows_x86_64
    if: >-
      ${{
        always() &&
        (needs.v8_android_arm32.result == 'success' || needs.v8_android_arm32.result == 'skipped') &&
        (needs.v8_android_arm64.result == 'success' || needs.v8_android_arm64.result == 'skipped') &&
        (needs.v8_android_x86_64.result == 'success' || needs.v8_android_x86_64.result == 'skipped') &&
        (needs.v8_ios_arm64.result == 'success' || needs.v8_ios_arm64.result == 'skipped') &&
        (needs.v8_macos_arm64.result == 'success' || needs.v8_macos_arm64.result == 'skipped') &&
        (needs.v8_macos_x86_64.result == 'success' || needs.v8_macos_x86_64.result == 'skipped') &&
        (needs.v8_linux_arm64.result == 'success' || needs.v8_linux_arm64.result == 'skipped') &&
        (needs.v8_linux_x86_64.result == 'success' || needs.v8_linux_x86_64.result == 'skipped') &&
        (needs.v8_windows_arm64.result == 'success' || needs.v8_windows_arm64.result == 'skipped') &&
        (needs.v8_windows_x86_64.result == 'success' || needs.v8_windows_x86_64.result == 'skipped') &&
        (needs.lws_linux_x86_64.result == 'success' || needs.lws_linux_x86_64.result == 'skipped') &&
        (needs.lws_linux_arm64.result == 'success' || needs.lws_linux_arm64.result == 'skipped') &&
        (needs.lws_android_arm64.result == 'success' || needs.lws_android_arm64.result == 'skipped') &&
        (needs.lws_android_arm32.result == 'success' || needs.lws_android_arm32.result == 'skipped') &&
        (needs.lws_android_x86_64.result == 'success' || needs.lws_android_x86_64.result == 'skipped') &&
        (needs.lws_ios_arm64.result == 'success' || needs.lws_ios_arm64.result == 'skipped') &&
        (needs.lws_macos_arm64.result == 'success' || needs.lws_macos_arm64.result == 'skipped') &&
        (needs.lws_macos_x86_64.result == 'success' || needs.lws_macos_x86_64.result == 'skipped') &&
        (needs.lws_windows_arm64.result == 'success' || needs.lws_windows_arm64.result == 'skipped') &&
        (needs.lws_windows_x86_64.result == 'success' || needs.lws_windows_x86_64.result == 'skipped')
      }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: staging/
          merge-multiple: true

      - name: packaging
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends zip unzip
          echo "Downloaded artifacts layout:"
          ls -R staging || true

          (cd staging && zip -r "v8_${{ github.event.inputs.v8_version }}.zip" v8/)
          echo "Created V8 bundle: staging/v8_${{ github.event.inputs.v8_version }}.zip"

          (cd staging && zip -r "lws_4.3.zip" lws/)
          echo "Created LWS bundle: staging/lws_4.3.zip"

      - name: Create Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.event.inputs.bundle_tag }}" \
            staging/*.zip \
            --title "${{ github.event.inputs.bundle_tag }}" \
            --notes "V8 and libwebsockets bundles." \
            --repo ${{ github.repository }} \
            --target ${{ github.sha }}
